openapi: 3.1.0
info:
  title: SnapRAID API
  description: Backend API for SnapRAID monitoring and control.
  license:
    name: BSD-2-Clause
    url: https://opensource.org/licenses/BSD-2-Clause
  version: 1.0.0
servers:
  - url: /

paths:
  /api/v1/probe:
    post:
      summary: Non-intrusive disk state discovery
      description: >
        Initiates a background scan of all data and parity disks to synchronize 
        their current power and health status. 
        
        The probe follows a 'safe-check' logic:
        1. It first queries the power state (standby vs. active).
        2. SMART attributes are only collected from disks that are already spinning.
        3. Disks in standby/idle mode are NOT woken up (spun up) during this process.
        
        This is automatically executed at daemon startup.
        This is an asynchronous operation. The updated metrics will be
        reflected in the '/api/v1/disks' endpoint upon completion.
        Returns 202 Accepted to acknowledge the task has been queued.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/smart:
    post:
      summary: Forced SMART attribute refresh
      description: >
        Triggers a comprehensive refresh of SMART telemetry for all data
        and parity disks.
        
        Unlike the 'probe' endpoint, this command will intentionally
        spin up any drives currently in standby to ensure fresh
        diagnostics are captured for every device in the array.
        
        This is an asynchronous operation. The updated metrics will be 
        reflected in the '/api/v1/disks' endpoint upon completion. 
        Returns 202 Accepted to acknowledge the task has been queued.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/up:
    post:
      summary: Bulk spin-up disk array
      description: >
        Commands all data and parity disks to transition from 'standby' to 
        'active' power mode. 
        
        This is useful for pre-heating the array before a heavy workload to
        avoid sequential spin-up delays.
        
        This is an asynchronous operation. Final power states will be 
        reflected in '/api/v1/disks' upon completion.
        Returns 202 Accepted to acknowledge the task has been queued.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/down:
    post:
      summary: Bulk spin-down disk array
      description: >
        Commands all data and parity disks to enter 'standby' (low-power) mode 
        immediately. 
        
        Any immediate system or array access following this command will
        cause the disks to spin back up. This is primarily 
        used for manual energy management or preparing for system 
        maintenance.
        
        This is an asynchronous operation. Final power states will be 
        reflected in '/api/v1/disks' upon completion.
        Returns 202 Accepted to acknowledge the task has been queued.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/diff:
    post:
      summary: Analyze array drift (Diff)
      description: >
        Triggers an asynchronous analysis of the array to identify changes 
        made since the last synchronization.
        
        This command compares the current file system state against the 
        existing parity metadata. It populates the 'diff_*' statistics 
        in the '/api/v1/array' endpoint, such as added, removed, moved, 
        and copied files.
        
        Unlike 'sync', this is a read-only operation and does not modify 
        the parity disks. Real-time progress is available via the 
        '/api/v1/progress' endpoint.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/status:
    post:
      summary: Audit array metadata and health
      description: >
        Triggers an asynchronous analysis of the array.
        
        While basic block counters are updated by most commands, this 
        endpoint provides a detailed analysis of disk fragmentation, 
        data distribution across drives, and the specific age of 
        scrubbed blocks.
        
        Returns 202 Accepted to acknowledge the task has been queued.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/sync:
    post:
      summary: Synchronize array parity
      description: >
        Initiates a synchronization task to update the parity information 
        across the array. This process ensures that the parity disks 
        accurately reflect the current state of all data disks.
        
        This is a resource-intensive, asynchronous operation. Real-time 
        progress, including percentage completion and estimated time 
        remaining, is available via the '/api/v1/progress' endpoint.
        Returns 202 Accepted to acknowledge the task has been queued.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/scrub:
    post:
      summary: Verify data integrity
      description: >
        Initiates an integrity check across the array to detect 'silent' 
        data corruption or bit-rot. This process reads data and parity 
        blocks to verify that the checksums still match.
        
        This is a resource-intensive, asynchronous operation that 
        validates the oldest parts of the array first. Real-time 
        progress and detected errors are available via the 
        '/api/v1/progress' endpoint. 
        
        Returns 202 Accepted to acknowledge the task has been queued.
      requestBody:
        $ref: '#/components/requestBodies/CommandRequest'
      responses:
        '202':
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Engine not found or execution failed.
          $ref: '#/components/responses/CommandResult'

  /api/v1/stop:
    post:
      summary: Stop active task
      description: >
        Terminates the currently running SnapRAID task (scrub, sync, etc.) by 
        sending a SIGTERM signal to the process.
        
        This command is synchronous in the sense that it returns only after 
        the signal has been successfully sent. However, the actual termination 
        of the SnapRAID process may take a few seconds to complete gracefully.
        
        Note that the pre_run_script and post_run_script are never terminated.
      responses:
        '202':
          $ref: '#/components/responses/CommandStopped'
        '409':
          description: No task is currently running.
          $ref: '#/components/responses/CommandResult'
        '500':
          description: Failed to send termination signal to the process group.
          $ref: '#/components/responses/CommandResult'

  /api/v1/disks:
    get:
      summary: Get cached disk inventory and status
      description: >
        Returns a comprehensive report of all data and parity disks managed 
        by the daemon. 
        
        This is a passive operation that retrieves the most recent 
        information stored in memory (cached from the last boot or 
        manual /probe, /smart, or /up commands). Calling this endpoint 
        will NOT trigger a physical disk probe or spin up any standby disks.
      responses:
        '200':
          description: Successfully retrieved disk state lists.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data_disks:
                    type: array
                    description: "Ordered list of data disks (d1, d2, ...)"
                    items:
                      $ref: '#/components/schemas/DataDisk'
                  parity_disks:
                    type: array
                    description: "Ordered list of parity disks (parity, 2-parity, ...)"
                    items:
                      $ref: '#/components/schemas/ParityDisk'

  /api/v1/progress:
    get:
      summary: Get active or recent task telemetry
      description: >
        Retrieves the real-time status of the currently executing task, 
        including progress percentage and estimated time remaining.
        
        If the system is idle, this returns the final report of the
        most recently completed task. Note that canceled tasks are immediately
        cleared and not reported here.
        
        Returns 204 No Content if the daemon has not executed any tasks 
        since the last restart.
      responses:
        '200':
          description: Active or historic task state retrieved.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '204':
          description: No task history available (system idle since startup).

  /api/v1/queue:
    get:
      summary: List pending tasks
      description: >
        Returns an ordered list of tasks currently waiting in the execution 
        pipeline. 
        
        This includes manually triggered commands and scheduled maintenance
        tasks that are blocked by the currently running process. Tasks are 
        executed sequentially; once a task starts, it moves from this
        queue to the '/progress' endpoint.
      responses:
        '200':
          description: A list of pending tasks retrieved successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'

  /api/v1/history:
    get:
      summary: List recent task history
      description: >
        Returns a list of the most recently completed, failed, or canceled 
        tasks in the current session.
        
        Tasks that successfully executed (terminated or signaled) are
        persistent across daemon restarts because the daemon re-processes 
        their individual log files from the 'log_directory' at startup.
        
        Instead, canceled tasks do not generate a log file. Consequently, 
        they are volatile, held only in memory, and are not persistent
        after a daemon restart.
        
        The history list is capped to include only entries from the last 30
        days, regardless of the 'log_retention_days' configuration option.
      responses:
        '200':
          description: A list of completed tasks retrieved successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'

  /api/v1/config:
    get:
      summary: Retrieve active daemon configuration
      description: >
        Returns the current operational parameters of the daemon. This includes
        settings parsed from 'snapraidd.conf' as well as any overrides applied
        during the current session.
      responses:
        '200':
          description: Configuration retrieved successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Config'

    patch:
      summary: Update configuration (Permanent)
      description: >
        Performs a partial update of the daemon settings. Validated changes are 
        immediately applied to the running process and persisted to the 
        'snapraidd.conf' file on disk. 
      requestBody:
        required: true
        description: JSON object containing the fields to be updated.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Config'
      responses:
        '200':
          description: Configuration updated and persisted to disk.
          $ref: '#/components/responses/CommandResult'
        '400':
          description: >
            Invalid configuration. One or more values failed validation (e.g., 
            unsupported log level or out-of-range scrub frequency).
          $ref: '#/components/responses/CommandResult'

  /api/v1/array:
    get:
      summary: Get array metadata and delta statistics
      description: >
        Returns the top-level logical state of the array. This includes 
        software versioning, SnapRAID block configuration, and the 
        timestamps of the most recent maintenance tasks. 
        
        The 'diff' statistics represent the drift between the actual 
        files on disk and the parity information, as recorded during 
        the last array check.
      responses:
        '200':
          description: Global array information retrieved successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Array'

components:
  requestBodies:
    CommandRequest:
      description: >
        A list of raw string arguments passed directly to the 
        SnapRAID process. These must follow SnapRAID CLI syntax.
      content:
        application/json:
          schema:
            type: object
            properties:
              args:
                type: array
                items:
                  type: string

  responses:
    CommandResult:
      description: >
        The request was successfully validated and added to the execution queue or failed.
      content:
        application/json:
          schema:
            type: object
            required:
              - success
            properties:
              success:
                type: boolean
                example: true
                description: >
                  Indicates if the operation was successfully added to the daemon's
                  internal worker queue
              message:
                type: string
                example: "Operation completed successfully."
                description: >
                  A human-readable status message or error detail.

    CommandStopped:
      description: >
        The stop command was successfully executed.
      content:
        application/json:
          schema:
            type: object
            required:
              - success
              - number
              - pid
            properties:
              success:
                type: boolean
                example: true
                description: >
                  Indicates if the operation was successful.
              message:
                type: string
                example: "Signal sent."
                description: >
                  A human-readable status message.
              number:
                type: integer
                example: 1
                description: >
                  Number of the task stopped.
              pid:
                type: integer
                example: 12345
                description: >
                  Process ID of the task stopped.

  schemas:
    Task:
      type: object
      description: >
        Progress status of the running or latest command. Persists until a new command begins.
      required:
        - number
        - command
        - health
        - status
        - messages
        - errors
      properties:
        number:
          type: integer
          description: >
            Incremental number of task. It can be used to identify tasks when moved from queue to process to history.
        command:
          type: string
          enum: [probe, up, down, smart, diff, status, sync, scrub, report]
          description: >
            The command executed.
        health:
          type: string
          enum: [passed, failing, pending]
          description: >
            The operational health of the task. This value is dynamically
            derived from the result of the operation done in the task.
            
            * 'passed': The task status is 'passed' if no hardware error was encountered.
            * 'failing': The task status is 'failing' if any I/O or data errors were encountered.
            * 'pending': The task is not yet executed.
        status:
          type: string
          enum: [queued, starting, processing, finishing, stopping, terminated, signaled, canceled]
          description: >
            The current status of the task:
            queued - Waiting to be executed.
            starting - The task started and it's executing it's initialization phase, like loading the content file.
            processing - The task is executing and you'll get progress information like `percentage`.
            finishing - The task finished and it's doing the final phase, like saving the content file.
            stopping - The task received a signal, and it's doing the final phase.
            terminated - The task terminated, `exit_code` contains it's return code.
            signaled - The task terminated by a signal. `exit_sig` contains it's signal code.
            canceled - The task was never executed because a previous operation failed. 
              For example, a canceled scrub because the previous sync failed.
              `exit_msg` contains the reason of the cancelation.
        exit_code:
          type: integer
          description: >
            Process exit code. Present only with status=terminated.
        exit_sig:
          type: integer
          description: >
            Process signal code. Present only with status=signaled.
        exit_msg:
          type: string
          description: >
            Reason for task cancellation. Present only with status=canceled.
            This field describes either a failed dependency in a task sequence (e.g., sync failed
            so scrub was skipped) or a safety suspension (e.g., sync_threshold_deletes reached).
        scheduled_at:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            The time when the task was added to the queue. 
            This timestamp is in local time.
        started_at:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            The server time when the task moved from 'queued' to 'starting'. 
            This timestamp is in local time.
        finished_at:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            The server time when the task reached a terminal state 
            (terminated, signaled, or canceled).
            This timestamp is in local time.
        progress:
          type: integer
          description: >
            Completion percentage. Only in 'processing'.
        eta_seconds:
          type: integer
          description: >
            Estimated time remaining in seconds. Only in 'processing'.
        speed_mbs:
          type: integer
          description: >
            Realtime speed in Mbytes/s. Only in 'processing'.
        cpu_usage:
          type: integer
          description: >
            CPU usage percentage. Only in 'processing'.
        elapsed_seconds:
          type: integer
          description: >
            Elapsed time in seconds. Only in 'processing'.
        block_begin:
          type: integer
          format: int64
          description: >
            Starting block index.
        block_end:
          type: integer
          format: int64
          description: >
            Ending block index + 1.
        block_count:
          type: integer
          format: int64
          description: >
            Number of blocks to process.
            It may be less than block_end - block_begin + 1 if some blocks are going to be skipped
        block_idx:
          type: integer
          format: int64
          description: >
            Current block index position processed. Only in 'processing'.
        block_done:
          type: integer
          format: int64
          description: >
            Number of blocks processed.
        size_done_bytes:
          type: integer
          format: int64
          description: >
            Size of blocks processed.
        log_file:
          type: string
          example: "/var/log/snapraid/20260112-sync.log"
          description: >
            The absolute path to the log file for this specific task execution. 
            This file is stored in the directory defined by 'log_directory' in the config.
        messages:
          type: array
          description: >
            List of messages.
          items:
            type: string
        error_io:
          type: integer
          format: int64
          example: 0
          description: >
            The count of physical Input/Output errors encountered in the task.
            This tracks hardware-level failures (disk, cable, or controller)
            recorded across the task execution.
            This field is available only on the `sync` and `scrub` command.
        error_data:
          type: integer
          format: int64
          example: 0
          description: >
            The count of data integrity errors encountered in the task. 
            This tracks 'silent' errors where a read was physically successful,
            but the data failed checksum verification, across the task execution.
            This field is available only on the `sync` and `scrub` command.
        error_bad:
          type: integer
          format: int64
          example: 0
          description: >
            The count of blocks marked bad. 
            This field is available only on the `status` command.
        errors:
          type: array
          description: >
            List of all errors encountered during the task. This includes also
            `soft` errors not caused by hardware failures. For example if
            during a sync a file is modified.
          items:
            type: string

    Device:
      type: object
      required:
        - device_node
        - health
        - power
      properties:
        device_node:
          type: string
          description: >
            System device path (e.g., /dev/sdb1).
        health:
          type: string
          enum: [passed, failing, pending]
          description: >
            The aggregate SMART health status of the physical device. 
            
            * 'passed': The drive is currently operating within manufacturer 
              specifications.
            * 'failing': The internal controller has detected an imminent 
              hardware fault (predictive failure). This is the primary 
              indicator for urgent disk replacement.
            * 'pending': Health data is not yet available. This typically 
              occurs if the disk is in standby mode and the daemon has 
              refrained from spinning it up to read SMART attributes.
        power:
          type: string
          enum: [active, standby, pending]
          description: >
            The current mechanical power state of the physical device.
            
            * 'active': The disk is spun up and the platters are rotating at 
              full speed. The device is ready for immediate I/O.
            * 'standby': The disk is spun down (low-power mode). The platters 
              are stationary. Any subsequent I/O will incur a spin-up delay.
            * 'pending': The power state has not yet been determined. This is 
              the default state upon daemon startup until the first hardware 
              probe is performed.
        family:
          type: string
          example: "Western Digital Red"
          description: >
            Vendor and Model Family.
        model:
          type: string
          example: "WDC WD40EFRX-68N32N0"
          description: >
            Model of the disk.
        serial:
          type: string
          example: "WD-WCC7K1XN2L3P"          
          description: >
            Serial of the disk.
        size_bytes:
          type: integer
          format: int64
          description: >
            Size in bytes of the raw device.
        rotational:
          type: integer
          example: 7200
          description: >
            The nominal rotation rate of the device in Revolutions Per Minute (RPM).
            Use this to distinguish between mechanical and solid-state storage:
            * 0: Non-rotational device (e.g., SSD, NVMe).
            * 1: Rotational device with an unknown or undetected speed.
            * >1: The actual detected rotational speed (e.g., 5400, 7200, 10000).
        error_protocol:
          type: integer
          description: >
            Counts command, transport, or controller-level errors reported
            by the device. These reflect failed I/O operations not directly
            caused by media defects (for example interface, firmware, or
            power-related errors).
            This counter is cumulative and never resets to zero, even if
            the underlying error condition is resolved.
        error_medium:
          type: integer
          description: >
            Counts media-level errors where data could not be reliably
            read or written. These indicate actual storage surface or
            flash failures and may imply data loss.
            This counter is cumulative and never resets to zero, even if
            the underlying error condition is resolved.
        wear_level:
          type: integer
          description: >
            The wear level of the SSD/NVME expressed as a percentage, where a
            value of 0 represents a brand new drive with zero wear and
            a value of 100 indicates the drive has reached or exceeded its
            manufacturer-rated design life. This metric is provided as a
            normalized unsigned integer, offering a consistent health
            indicator across various SSD/NVME vendors and interface types
            by mapping diverse hardware counters into a single
            standardized scale.
        reallocated_sector_count:
          type: integer
          description: >
            The count of reallocated sectors (SMART ID 5). When the hard drive 
            finds a read/write/verification error, it marks this sector as 
            "reallocated" and transfers data to a special reserved area.
        uncorrectable_error_cnt:
          type: integer
          description: >
            The total count of uncorrectable errors when reading/writing a sector 
            (SMART ID 187). A rise in this value indicates hardware defects 
            that the drive's internal error correction (ECC) could not recover.
        command_timeout:
          type: integer
          description: >
            The count of aborted operations due to HDD timeout (SMART ID 188). 
            This can be caused by power supply issues, cable oxidation, 
            or internal drive failures.
        current_pending_sector:
          type: integer
          description: >
            The number of unstable sectors waiting to be remapped (SMART ID 197). 
            If a sector is subsequently read successfully, the count decreases; 
            if it fails again, it becomes a reallocated sector.
        offline_uncorrectable:
          type: integer
          description: >
            The total number of uncorrectable errors during offline scan 
            (SMART ID 198). This represents failures discovered during 
            the drive's internal self-tests rather than during host I/O.
        start_stop_count:
          type: integer
          description: >
            The cumulative count of spindle start/stop cycles (SMART ID 4). 
            In the context of snapraidd, this helps monitor the mechanical 
            wear caused by aggressive spindown power management policies.
        power_on_hours:
          type: integer
          description: >
            The total number of hours the drive has been powered on (SMART ID 9). 
            Used as a primary metric for determining the age and remaining 
            service life of the physical disk.
        load_cycle_count:
          type: integer
          description: >
            The number of times the heads have been parked in the landing zone 
            (SMART ID 193). High values are common in green/energy-efficient 
            drives but may indicate excessive head parking.
        temperature_celsius:
          type: integer
          description: >
            The current internal temperature of the drive in degrees Celsius 
            (SMART ID 194 or 190). Maintaining consistent temperatures 
            below 45Â°C is critical for long-term platter and motor reliability.
        annual_failure_rate:
          type: number
          format: double
          description: >
            The Annual Failure Rate (the average number	of failures you expect
            in a year) computed from the SMART attributes 5, 187, 188, 197, 198.
        failure_probability:
          type: number
          format: double
          description: >
            Statistical probability of at least one disk failure within a 
            one-year period, calculated using a Poisson distribution model 
            based on the aggregate Annual Failure Rate.

    BaseDisk:
      type: object
      required: [name, health, power]
      properties:
        name:
          type: string
          description: >
            Logical name (e.g., d1, d2, ..., parity, 2-parity, ...).
        health:
          type: string
          enum: [passed, failing, pending]
          description: >
            The aggregate operational health of the disk. This value is 
            dynamically derived from:
            1. The hardware health of the underlying physical devices.
            2. The 'error_io' counter (communication/transport failures).
            3. The 'error_data' counter (silent corruption/checksum mismatches).
            
            * 'passed': The device status is 'passed' and all error counters are zero.
            * 'failing': The device status is 'failing' OR any unrecoverable 
              I/O or data errors have been recorded in the current session.
            * 'pending': The underlying device health is 'pending' and no 
              runtime errors have been recorded yet.
        power:
          type: string
          enum: [active, standby, pending]
          description: >
            The logical power state of the disk, mirrored from the underlying 
            physical device.
            
            * 'active': The disk is spun up. Operations like 'sync' or 'scrub' 
              on this disk will start immediately.
            * 'standby': The disk is spun down. Any array operation will 
              require a 10-15 second spin-up delay before data can be read.
            * 'pending': The power state is currently unknown. The daemon 
              is waiting for the next probe or array command to verify if 
              the disk is spinning.
        allocated_space_bytes:
          type: integer
          format: int64
        free_space_bytes:
          type: integer
          format: int64
        access_count:
          type: integer
          format: int64
          example: 1250432
          description: >
            The total number of read and write operations processed by the
            disk since the last system boot. This value is a cumulative
            counter provided by the kernel.
        access_count_initial_time:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            The timestamp when the daemon first sampled 'access_count'.
            This timestamp is in local time.
        access_count_idle_duration:
          type: integer
          format: int64
          example: 3600
          description: >
            The number of seconds elapsed since the 'access_count' last
            increased. This value measures continuous inactivity and is
            used to determine if the disk is a candidate for spin-down
            to save power.
        error_io:
          type: integer
          format: int64
          example: 0
          description: >
            The accumulated count of physical Input/Output errors encountered
            since the daemon started. This tracks hardware-level failures
            (disk, cable, or controller) recorded across all tasks executed
            during the current session uptime.
            This accumulated counter is cleared after a `scrub` command
            reports that no blocks are bad.
        error_data:
          type: integer
          format: int64
          example: 0
          description: >
            The accumulated count of data integrity errors encountered since
            the daemon started. This tracks 'silent' errors where a read
            was physically successful, but the data failed checksum
            verification, across all tasks in the current session.
            This accumulated counter is cleared after a `scrub` command
            reports that no blocks are bad.

    DataDisk:
      allOf:
        - $ref: '#/components/schemas/BaseDisk'
        - type: object
          required: [mount_dir, devices]
          properties:
            mount_dir:
              type: string
              description: >
                Filesystem mount point path.
            uuid:
              type: string
              description: >
                Actual UUID of the filesystem containing the mount dir.
            stored_uuid:
              type: string
              description: >
                Stored UUID of the filesystem containing the mount dir.
            devices:
              type: array
              items:
                $ref: '#/components/schemas/Device'

    ParitySplit:
      type: object
      required:
        - parity_path
        - devices
      properties:
        parity_path:
          type: string
          description: >
            Path to the parity file.
        uuid:
          type: string
          description: >
            Actual UUID of the filesystem containing the parity file.
        stored_uuid:
          type: string
          description: >
            Stored UUID of the filesystem containing the parity file.
        devices:
          type: array
          items:
            $ref: '#/components/schemas/Device'

    ParityDisk:
      allOf:
        - $ref: '#/components/schemas/BaseDisk'
        - type: object
          required: [splits]
          properties:
            splits:
              type: array
              items:
                $ref: '#/components/schemas/ParitySplit'

    Config:
      type: object
      description: Global configuration state for the SnapRAID daemon.
      properties:
        scheduled_run:
          type: string
          example: "daily 02:00"
          description: >
            Execution schedule for the automated 'sync' and 'scrub' sequence. 
            Accepted formats: "daily HH:MM" or "weekly <day> HH:MM". If empty, 
            background maintenance is disabled.
        sync_threshold_deletes:
          type: integer
          format: int32
          default: 0
          example: 50
          description: >
            Threshold for deleted files. If the number of missing files exceeds 
            this value, the sync operation is suspended. 
            This threshold is ignored for manual syncs triggered 
            via the API. Set to 0 for no threshold.
        sync_threshold_updates:
          type: integer
          format: int32
          default: 0
          example: 500
          description: >
            Threshold for updated files. If the number of files with changed 
            sizes or timestamps exceeds this value, the sync operation is 
            suspended.
            This threshold is ignored for manual syncs triggered 
            via the API. Set to 0 for no threshold.
        sync_prehash:
          type: boolean
          example: true
          description: >
            Calculates hashes for new or modified files before updating 
            parity. Protects against integrating data corrupted by 
            faulty RAM or cables.
        sync_force_zero:
          type: boolean
          example: false
          description: >
            Permits parity synchronization even if existing files have 
            unexpectedly shrunk to zero bytes.
        scrub_percentage:
          type: integer
          minimum: 0
          maximum: 100
          example: 12
          description: >
            The percentage of the array verified during the scrub phase of 
            scheduled maintenance. Set to 0 to skip the scrub phase.
        scrub_older_than:
          type: integer
          minimum: 0
          maximum: 1000
          example: 10
          description: >
            Restricts scrubbing to data blocks not verified within the last 
            N days. Set to 0 to ignore block age.
        probe_interval_minutes:
          type: integer
          example: 15
          description: >
            Interval for background health monitoring. The daemon probes 
            disk power state; SMART attributes are only queried if the 
            disk is already in an active/idle state to prevent spin-up. 
            Set to 0 to disable monitoring.
        spindown_idle_minutes:
          type: integer
          example: 30
          description: >
            Inactivity threshold for disk spindown. Activity defined as
            physical read/write I/O. Power-state probes do not reset
            this timer but allow more frequent I/O detection.
            Set to 0 to disable.
        pre_run_script:
          type: string
          example: "/usr/local/bin/pre-snapraid.sh"
          description: >
            Absolute path to an executable shell script invoked prior to 
            SnapRAID tasks. Must contain a valid shebang. Compiled binaries 
            are not supported.
        post_run_script:
          type: string
          example: "/usr/local/bin/post-snapraid.sh"
          description: >
            Absolute path to an executable shell script invoked after 
            SnapRAID tasks (on success or failure). Must contain a valid 
            shebang. Compiled binaries are not supported.
        log_directory:
          type: string
          example: "/var/log/snapraid/"
          description: >
            Persistence directory for execution logs (YYYYMMDD-command.log). 
            Logs are used as the primary data source to rehydrate task 
            history in-memory upon daemon restart.
        log_retention_days:
          type: integer
          example: 30
          description: >
            Retention window for log files. Deleting logs via this cleanup 
            policy removes the corresponding entries from the API history. 
            Set to 0 for indefinite retention.
        notify_syslog_enabled:
          type: boolean
          example: true
          description: >
            Enables logging to syslog/journald. Lifecycle events (start, 
            stop, reload) are logged regardless of severity level if this 
            is true.
        notify_syslog_level:
          type: string
          enum: [critical, error, warning, info]
          description: >
            Minimum severity filter for task-related syslog entries. 
            Defaults to 'critical' if unset.
        notify_heartbeat:
          type: string
          example: "curl -fsS --max-time 30 --retry 3 https://hc-ping.com/..."
          description: >
            Shell command executed only upon task success (exit code 0). 
            Used for external 'dead man's switch' telemetry.
            Disabled if empty.
        notify_result:
          type: string
          example: "curl -fsS --data-binary @- https://ntfy.sh/topic"
          description: >
            Shell command executed after task completion. The daemon pipes 
            the task report (plain-text) into the command's stdin.
            Disabled if empty.
        notify_result_level:
          type: string
          enum: [critical, error, warning, info]
          description: >
            Minimum severity threshold required to trigger the 'notify_result' 
            command.
        notify_email_recipient:
          type: string
          format: email
          description: >
            Destination address for health reports sent via local system 
            mail (sendmail/postfix). Disabled if empty.
        notify_email_level:
          type: string
          enum: [critical, error, warning, info]
          description: >
            Minimum severity threshold for dispatching local email reports.
        notify_differences:
          type: boolean
          example: true
          description: >
            Includes a detailed list of added/removed/modified files in 
            the 'notify_result' and 'notify_email' report bodies.

    Array:
      type: object
      description: >
        Comprehensive state of array configuration, health metrics, and execution metadata.
      required:
        - daemon_version
        - health
      properties:
        daemon_version:
          type: string
          example: "13.1"
          description: >
            The version of the snapraidd C daemon currently running.
        engine_version:
          type: string
          example: "13.1"
          description: >
            The version of the underlying SnapRAID binary.
        health:
          type: string
          enum: [passed, failing, pending]
          description: >
            The operational health of the array. This value is dynamically
            derived from the health of all disks and the bad blocks status
            present in the content file.
            
            * 'passed': The status is 'passed' if no hardware error was encountered.
            * 'failing': The status is 'failing' if any I/O or data errors were encountered.
            * 'pending': The status is not yet established.
        conf:
          type: string
          example: "/etc/snapraid.conf"
          description: >
            Absolute path to the SnapRAID configuration file.
        content:
          type: string
          example: "/var/snapraid/snapraid.content"
          description: >
            Absolute path to the primary SnapRAID content file.
        block_size_bytes:
          type: integer
          example: 262144
          description: >
            Array block size in bytes (always power of 2).
        last_time:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            Local timestamp of the most recently concluded task.
        last_cmd:
          type: string
          enum: [probe, up, down, smart, diff, status, sync, scrub]
          description: >
            Identifier of the last successfully completed command.
        annual_failure_rate:
          type: number
          format: double
          description: >
            The arithmetic sum of the Annual Failure Rates (AFR) for all disks 
            in the array, representing the expected number of device 
            failures per year.
        failure_probability:
          type: number
          format: double
          description: >
            Statistical probability of at least one disk failure within a 
            one-year period, calculated using a Poisson distribution model 
            based on the aggregate Annual Failure Rate.
        file_count:
          type: integer
          format: int64
          description: >
            Total number of files tracked in the content file.
        last_status_at:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            Local timestamp of the last 'status' command execution.
        block_bad:
          type: integer
          format: int64
          example: 0
          description: >
            Count of blocks flagged as 'bad' in the content file.
        block_rehash:
          type: integer
          format: int64
          example: 0
          description: >
            Count of blocks requiring a rehash for parity consistency.
        block_count:
          type: integer
          format: int64
          example: 0
          description: >
            The total number of blocks as reported by the content file. 
            It can be used to compute the percentage of rehash needed.
        last_diff_at:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            Local timestamp of the last array change analysis ('diff').
        last_sync_at:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            Local timestamp of the last parity synchronization ('sync').
        last_scrub_at:
          type: string
          example: "2026-01-12T08:00:00"
          description: >
            Local timestamp of the last data integrity verification ('scrub').
        diff_equal:
          type: integer
          format: int64
          description: >
            The count of files whose metadata and data match the current parity.
        diff_added:
          type: integer
          format: int64
          description: >
            The count of brand new files not present in the last sync.
        diff_removed:
          type: integer
          format: int64
          description: >
            The count of files that existed in the last sync but are now missing.
        diff_updated:
          type: integer
          format: int64
          description: >
            The count of existing files where the timestamp or size has changed.
        diff_moved:
          type: integer
          format: int64
          description: >
            The count of files relocated to a new path or renamed but retaining the same inode.
        diff_copied:
          type: integer
          format: int64
          description: >
            The count of new files created by copying an existing protected file to a new path.
        diff_restored:
          type: integer
          format: int64
          description: >
            The count of new files matching a parity entry by name/time/size but with a new inode (e.g., replaced from backup).
